"""
Tests for layer 1
"""
# Author: Alex Hepburn <alex.hepburn@bristol.ac.uk>
# License: new BSD

import pytest

import numpy as np

import torch
import torch.nn as nn

import expert
import expert.layers.layer_1 as ell1


class TestLayer1():
    """
    Tests :class:`expert.layers.layer_1.Layer1` class.
    """
    expert.setup_random_seed()
    layer1 = ell1.Layer1()

    def test_init(self):
        """
        Test :class:`expert.layers.layer_1.Layer1` class init.
        """
        return True

    def test_forward(self):
        """
        Test :func:`expert.layers.layer_1.Layer1.forward` function.
        """
        x = torch.zeros(9, 6)
        x[4, :] = torch.arange(0, 0.6, 0.1)
        [y, y_dn] = self.layer1.forward(x)

        correct_y = torch.ones(9, 6)*1e-6
        correct_y[4, :] = torch.arange(0, 0.6, 0.1)

        correct_y_dn = torch.Tensor([
            [4.0819e-4, 1.9524e-4, 1.1203e-4, 7.5627e-5, 5.6173e-5, 4.4355e-5],
            [4.0819e-4, 1.9524e-4, 1.1203e-4, 7.5627e-5, 5.6173e-5, 4.4355e-5],
            [4.0819e-4, 1.9524e-4, 1.1203e-4, 7.5627e-5, 5.6173e-5, 4.4355e-5],
            [4.0819e-4, 1.9524e-4, 1.1203e-4, 7.5627e-5, 5.6173e-5, 4.4355e-5],
            [4.0819e-4, 183.1477, 202.9864, 212.1136, 218.9164, 225.0190],
            [4.0819e-4, 1.9524e-4, 1.1203e-4, 7.5627e-5, 5.6173e-5, 4.4355e-5],
            [4.0819e-4, 1.9524e-4, 1.1203e-4, 7.5627e-5, 5.6173e-5, 4.4355e-5],
            [4.0819e-4, 1.9524e-4, 1.1203e-4, 7.5627e-5, 5.6173e-5, 4.4355e-5],
            [4.0819e-4, 1.9524e-4, 1.1203e-4, 7.5627e-5, 5.6173e-5, 4.4355e-5]])

        assert torch.allclose(correct_y, y, atol=1e-6)
        correct_y_dn_small = correct_y_dn[[0, 1, 2, 3, 5, 6, 7, 8], :]
        y_dn_small = y_dn[[0, 1, 2, 3, 5, 6, 7, 8], :]
        assert torch.allclose(correct_y_dn_small, y_dn_small, atol=1e-7)
        assert torch.allclose(correct_y_dn[4, :], y_dn[4, :], atol=1e-2)

        x = torch.zeros(9, 6) + 0.125
        x[4, :] = torch.arange(0, 0.6, 0.1)
        [y, y_dn] = self.layer1.forward(x)

        correct_y = torch.ones(9, 6) * 0.125
        correct_y[4, :] = torch.arange(0, 0.6, 0.1)

        correct_y_dn = torch.Tensor([
            [98.3638, 93.9948, 88.3901, 82.7941, 77.5418, 72.7431],
            [98.3638, 93.9948, 88.3901, 82.7941, 77.5418, 72.7431],
            [98.3638, 93.9948, 88.3901, 82.7941, 77.5418, 72.7431],
            [98.3638, 93.9948, 88.3901, 82.7941, 77.5418, 72.7431],
            [3.5350e-5, 76.5588, 130.0170, 162.9414, 185.2633, 201.8940],
            [98.3638, 93.9948, 88.3901, 82.7941, 77.5418, 72.7431],
            [98.3638, 93.9948, 88.3901, 82.7941, 77.5418, 72.7431],
            [98.3638, 93.9948, 88.3901, 82.7941, 77.5418, 72.7431],
            [98.3638, 93.9948, 88.3901, 82.7941, 77.5418, 72.7431]])

        assert torch.allclose(correct_y, y, atol=1e-6)
        assert torch.allclose(correct_y_dn, y_dn, atol=1e-2)


class TestLayer2():
    """
    Tests :class:`expert.layers.layer_1.Layer2` class.
    """
    expert.setup_random_seed()
    layer2 = ell1.Layer2()

    def test_init(self):
        """
        Test :class:`expert.layers.layer_1.Layer2` class init.
        """
        return True

    def test_forward(self):
        """
        Test :func:`expert.layers.layer_1.Layer2.forward` function.
        """
        x = torch.Tensor([54.2545, 54.4370, 52.5493, 66.0231, 67.9172, 72.2044,
                          82.3919, 82.1441, 84.4466, 74.9919, 69.7561,
                          51.4902, 63.9187, 59.8488, 64.1332, 78.2811])
        [y, y_dn] = self.layer2(x)
        correct_y = torch.Tensor([46.2944, 46.0439, 44.1495, 58.0438, 59.5077,
                                  63.3382, 73.5195, 73.7167, 76.0166, 66.1050,
                                  60.8637, 43.0445, 55.9005, 51.3966, 55.6764,
                                  70.2498])
        correct_y_dn = torch.Tensor([1.2196, 1.1993, 1.1497, 1.5283, 1.5493,
                                     1.6296, 1.8913, 1.9183, 1.9781, 1.7000,
                                     1.5649, 1.1196, 1.4704, 1.3366, 1.4478,
                                     1.8472])

        assert torch.allclose(correct_y, y.squeeze(), atol=1e-3)
        assert torch.allclose(correct_y_dn, y_dn.squeeze(), atol=1e-3)


def test_make_2d_gauss_kernel():
    """
    """
    fs = 64
    N = 2
    sigma = 0.0660
    (H, dHds) = ell1.make_2d_gauss_kernel(fs, N, sigma)
    correct_H = torch.Tensor([
        [0.0089, 0.0087, 0.0087, 0.0084],
        [0.0087, 0.0089, 0.0084, 0.0087],
        [0.0087, 0.0084, 0.0089, 0.0087],
        [0.0084, 0.0087, 0.0087, 0.0089]])
    correct_dHds = torch.Tensor([
        [-0.2703, -0.2555, -0.2555, -0.2413],
        [-0.2555, -0.2703, -0.2413, -0.2555],
        [-0.2555, -0.2413, -0.2703, -0.2555],
        [-0.2413, -0.2555, -0.2555, -0.2703]])
    assert torch.allclose(correct_H, H, atol=1e-4)
    assert torch.allclose(correct_dHds, dHds, atol=1e-4)


class TestLayer3():
    """
    Tests :class:`expert.layers.layer_1.Layer3` class.
    """
    expert.setup_random_seed()
    layer3 = ell1.Layer3()

    def test_init(self):
        """
        Test :class:`expert.layers.layer_1.Layer3` class init.
        """
        return True

    def test_forward(self):
        """
        Test :func:`expert.layers.layer_1.Layer3.forward` function.
        """
        x = torch.Tensor([1.5060, 1.6206, 1.4715, 1.6843, 1.4584, 1.4719,
                          1.5168, 1.7102, 1.9397, 1.8849, 1.8148, 1.7293,
                          1.4438, 1.4452, 1.3708, 1.5931]).unsqueeze(1)
        [y, y_dn] = self.layer3(x)
        correct_y = torch.Tensor([1.5195, 1.5270, 1.5604, 1.6281, 1.5977,
                                  1.5977, 1.6018, 1.6437, 1.6722, 1.6785,
                                  1.6869, 1.7224, 1.5938, 1.5659, 1.5527,
                                  1.6013]).unsqueeze(1)
        correct_y_dn = torch.Tensor([2.1141, 1.6176, 1.6502, 2.2674, 1.7090,
                                     1.2973, 1.2899, 1.7375, 1.8055, 1.3816,
                                     1.3827, 1.8530, 2.1958, 1.6351, 1.6074,
                                     2.1848]).unsqueeze(1)
        assert torch.allclose(correct_y, y, atol=1e-3)
        assert torch.allclose(correct_y_dn, y_dn, atol=1e-3)


class TestLayer4():
    """
    Tests :class:`expert.layers.layer_1.Layer4` class.
    """
    expert.setup_random_seed()
    layer4 = ell1.Layer4()

    def test_init(self):
        """
        Test :class:`expert.layers.layer_1.Layer4` class init.
        """
        return True

    def test_forward(self):
        """
        Test :func:`expert.layers.layer_1.Layer4.forward` function.
        """
        x = torch.Tensor(
            [0.037217, 0.030661, 0.027811, 0.029849, 0.031825, 0.031889,
             0.029004, 0.027365, 0.031324, 0.042799, 0.056441, 0.063025,
             0.061467, 0.065966, 0.069614, 0.089788, 0.032476, 0.029882,
             0.028425, 0.029234, 0.028882, 0.026386, 0.022004, 0.019414,
             0.021942, 0.030417, 0.040666, 0.047628, 0.048557, 0.053264,
             0.057535, 0.069642, 0.033284, 0.027984, 0.023551, 0.021396,
             0.01858, 0.014782, 0.00947, 0.006194, 0.008174, 0.016848,
             0.027513, 0.036678, 0.039005, 0.043222, 0.047681, 0.056991,
             0.037325, 0.028615, 0.021282, 0.015345, 0.008651, 0.003059,
             -0.000041, -0.002312, -0.001123, 0.002565, 0.011791, 0.02362,
             0.02887, 0.034193, 0.038959, 0.04559, 0.043149, 0.032455,
             0.023006, 0.013745, 0.003795, -0.001385, -0.008895, -0.017349,
             -0.018875, -0.008173, 0.000016, 0.009679, 0.018618, 0.026864,
             0.034, 0.039383, 0.049669, 0.036668, 0.025868, 0.015101,
             0.003139, -0.00456, -0.017163, -0.031934, -0.046156, -0.030652,
             -0.009697, 0.001661, 0.011297, 0.020967, 0.029549, 0.035144,
             0.057136, 0.042543, 0.030897, 0.018388, 0.003914, -0.005587,
             -0.019874, -0.039954, -0.066662, -0.045682, -0.015623, 0.000239,
             0.009845, 0.019927, 0.02885, 0.034579, 0.061444, 0.04639,
             0.035208, 0.02158, 0.004904, -0.004785, -0.017983, -0.04138,
             -0.080791, -0.053674, -0.016848, 0.00034, 0.011425, 0.021947,
             0.030876, 0.037622, 0.060174, 0.044652, 0.03374, 0.019935,
             0.00402, -0.003137, -0.015231, -0.041305, -0.096304, -0.059674,
             -0.017928, 0.000912, 0.014955, 0.027547, 0.036933, 0.04734,
             0.053374, 0.04071, 0.02983, 0.015602, 0.002353, -0.001829,
             -0.006422, -0.014768, -0.033841, -0.021144, -0.004577, 0.006262,
             0.021895, 0.035009, 0.044302, 0.058185, 0.055532, 0.044606,
             0.034993, 0.021166, 0.005897, -0.000408, -0.004255, -0.006853,
             -0.011324, -0.003405, 0.001805, 0.015591, 0.030633, 0.041422,
             0.049066, 0.065317, 0.056817, 0.047625, 0.040445, 0.029297,
             0.014661, 0.003425, -0.000692, -0.00306, -0.004772, -0.000282,
             0.005052, 0.0193, 0.035128, 0.046885, 0.055334, 0.074731,
             0.051443, 0.044165, 0.038596, 0.030693, 0.019976, 0.011122,
             0.005751, 0.004022, 0.002297, 0.003274, 0.007905, 0.018852,
             0.03477, 0.048905, 0.058601, 0.078246, 0.048195, 0.042549,
             0.038817, 0.03357, 0.025894, 0.019357, 0.014887, 0.013827,
             0.012867, 0.014068, 0.0183, 0.027081, 0.039577, 0.051537,
             0.061201, 0.079798, 0.054745, 0.048446, 0.045242, 0.040675,
             0.033793, 0.027599, 0.023448, 0.022721, 0.022805, 0.024828,
             0.029293, 0.037206, 0.047511, 0.057726, 0.066336, 0.085551,
             0.071952, 0.059809, 0.055516, 0.050512, 0.043466, 0.036702,
             0.032457, 0.03204, 0.032078, 0.034589, 0.040202, 0.049652,
             0.060534, 0.070999, 0.081366, 0.112465]).unsqueeze(1)
        [y, y_dn] = self.layer4(x)

        true_y = torch.Tensor(
            [-0.01710, -0.002970, -0.005994, -0.006145, -0.003105, -0.000470,
             -0.000790, -0.001243, -0.000060, 0.002426, -0.252321, 0.331186,
             0.727276, 0.004846, -0.570891, 0.151539, 1.002156, 0.389450,
             0.083561, 0.696267]).unsqueeze(1)
        true_y_dn = torch.Tensor([
            -0.000174, -0.000061, -0.000093, -0.000094, -0.000063, -0.000020,
            -0.000028, -0.000036, -0.000006, 0.000054, -0.000875, 0.001030,
            0.001652, 0.000082, -0.001429, 0.000645, 0.002002, 0.001136,
            0.000451, 0.001609]).unsqueeze(1)
        y_test = torch.cat([y[0:10, :], y[-10:]])
        y_dn_test = torch.cat([y_dn[0:10, :], y_dn[-10:]])
        assert torch.allclose(true_y, y_test, atol=1e-4)

        import numpy as np
        np.printoptions(precision=6, suppress=True)
        assert torch.allclose(true_y_dn, y_dn_test, atol=1e-4)


def test_make_wavelet_kernel_2():
    """
    TODO: testing
    """
    w, ind = ell1.make_wavelet_kernel_2(16, 2, 4, 1, 0, 1)
    print(ind)
    sys.exit(0)


def test_kernel_s_wavelet_spatial():
    """
    """
    ind = [[16, 16]]*5 + [[8, 8]]*4 + [[4, 4]]
    H_spatial = ell1.kernel_s_wavelet_spatial(ind, 64, [0.24])
    true_upper_right = torch.Tensor([
        [0.6746, 0.6732, 0.6689, 0.6618, 0.6521, 0.6398, 0.6250, 0.6080,
         0.5890],
        [0.6732, 0.6746, 0.6732, 0.6689, 0.6618, 0.6521, 0.6398, 0.6250,
         0.6080],
        [0.6689, 0.6732, 0.6746, 0.6732, 0.6689, 0.6618, 0.6521, 0.6398,
         0.6250],
        [0.6618, 0.6689, 0.6732, 0.6746, 0.6732, 0.6689, 0.6618, 0.6521,
         0.6398],
        [0.6521, 0.6618, 0.6689, 0.6732, 0.6746, 0.6732, 0.6689, 0.6618,
         0.6521],
        [0.6398, 0.6521, 0.6618, 0.6689, 0.6732, 0.6746, 0.6732, 0.6689,
         0.6618],
        [0.6250, 0.6398, 0.6521, 0.6618, 0.6689, 0.6732, 0.6746, 0.6732,
         0.6689],
        [0.6080, 0.6250, 0.6398, 0.6521, 0.6618, 0.6689, 0.6732, 0.6746,
         0.6732],
        [0.5890, 0.6080, 0.6250, 0.6398, 0.6521, 0.6618, 0.6689, 0.6732,
         0.6746]])
    true_bottom_right = torch.Tensor([
        [0.0108, 0.0077, 0.0091, 0.0101, 0.0104, 0.0069, 0.0082, 0.0091,
         0.0094],
        [0.0077, 0.0108, 0.0104, 0.0094, 0.0080, 0.0104, 0.0101, 0.0091,
         0.0077],
        [0.0091, 0.0104, 0.0108, 0.0104, 0.0094, 0.0101, 0.0104, 0.0101,
         0.0091],
        [0.0101, 0.0094, 0.0104, 0.0108, 0.0104, 0.0091, 0.0101, 0.0104,
         0.0101],
        [0.0104, 0.0080, 0.0094, 0.0104, 0.0108, 0.0077, 0.0091, 0.0101,
         0.0104],
        [0.0069, 0.0104, 0.0101, 0.0091, 0.0077, 0.0108, 0.0104, 0.0094,
         0.0080],
        [0.0082, 0.0101, 0.0104, 0.0101, 0.0091, 0.0104, 0.0108, 0.0104,
         0.0094],
        [0.0091, 0.0091, 0.0101, 0.0104, 0.0101, 0.0094, 0.0104, 0.0108,
         0.0104],
        [0.0094, 0.0077, 0.0091, 0.0101, 0.0104, 0.0080, 0.0094, 0.0104,
         0.0108]])
    assert torch.allclose(true_upper_right, H_spatial[0:9, 0:9], atol=1e-3)
    assert torch.allclose(true_bottom_right, H_spatial[-9:, -9:], atol=1e-3)


def test_spatio_temp_freq_domain():
    """
    """
    (x, y, t, fx, fy, ft) = ell1.spatio_temp_freq_domain(10, 10, 1, 64, 64, 1)
    correct_x = torch.Tensor([0, 0.0156, 0.0313, 0.0469, 0.0625, 0.0781, 0.0938,
                              0.1094, 0.1250, 0.1406])
    correct_x = correct_x.repeat(10, 1)
    correct_y = correct_x.T
    correct_t = torch.zeros(10, 10)
    correct_fx = torch.Tensor([-32, -25.6, -19.2, -12.8, -6.4, 0, 6.4, 12.8,
                               19.2, 25.6])
    correct_fx = correct_fx.repeat(10, 1)
    correct_fy = correct_fx.T
    correct_ft = torch.zeros(10, 10)

    assert torch.allclose(correct_x, x, atol=1e-4)
    assert torch.allclose(correct_y, y, atol=1e-4)
    assert torch.allclose(correct_t, t, atol=1e-4)
    assert torch.allclose(correct_fx, fx, atol=1e-4)
    assert torch.allclose(correct_fy, fy, atol=1e-4)
    assert torch.allclose(correct_ft, ft, atol=1e-4)


def test_metefot():
    """
    """
    sec = torch.zeros(10, 10)
    fot_x = torch.Tensor([0, 0.0156, 0.0313, 0.0469, 0.0625, 0.0781, 0.0938,
                          0.1094, 0.1250, 0.1406])
    foto = fot_x.repeat(10, 1)
    N = 1
    ma = 1
    sec = ell1.metefot(sec, foto, N, ma)

    correct_sec = torch.allclose(foto, sec, atol=1e-4)


def test_freqspace():
    """
    """
    N = [10, 10]
    flag = 'meshgrid'
    [fx, fy] = ell1.freqspace(N, flag)

    correct_fx = torch.Tensor([-1, -0.8, -0.6, -0.4, -0.2, 0, 0.2, 0.4, 0.6,
                               0.8])
    correct_fx = correct_fx.repeat(N[0], 1)
    correct_fy = torch.Tensor([-1, -0.8, -0.6, -0.4, -0.2, 0, 0.2, 0.4, 0.6,
                               0.8])
    correct_fy = correct_fy.repeat(N[1], 1).T

    assert torch.allclose(correct_fx, fx, atol=1e-4)
    assert torch.allclose(correct_fy, fy, atol=1e-4)


def test_make_csf_kernel():
    """
    """
    hh, gn = ell1.make_csf_kernel(64, 4, 1, 1)
    correct_hh = torch.Tensor([
        [0.4194, 0.2456, 0., 0., 0.2456, 0.0895, 0., 0., 0., 0., 0., 0., 0.,
         0., 0., 0.],
        [0.1840, 0.3141, 0.1840, 0., 0.0670, 0.1840, 0.0670, 0., 0., 0., 0.,
         0., 0., 0., 0., 0.],
        [0.0829, 0.1732, 0.2958, 0.1732, -0.025, 0.0631, 0.1732, 0.0631, 0.,
         0., 0., 0., 0., 0., 0., 0.],
        [0., 0.1085, 0.2268, 0.3873, 0., -0.0321, 0.0826, 0.2268, 0., 0., 0.,
         0., 0., 0., 0., 0.],
        [0.1840, 0.0670, 0., 0., 0.3141, 0.1840, 0., 0., 0.1840, 0.0670, 0.,
         0., 0., 0., 0., 0.],
        [0.0508, 0.1396, 0.0508, 0., 0.1396, 0.2383, 0.1396, 0., 0.0508,
         0.1396, 0.0508, 0., 0., 0., 0., 0.],
        [-0.0192, 0.0495, 0.1359, 0.0495, 0.0650, 0.1359, 0.2320, 0.1359,
         -0.0192, 0.0495, 0.1359, 0.0495, 0., 0., 0., 0.],
        [0., -0.0251, 0.0647, 0.1776, 0., 0.0849, 0.1776, 0.3032, 0., -0.0251,
         0.064, 0.1776, 0., 0., 0., 0.],
        [0.0829, -0.0245, 0., 0., 0.1732, 0.0631, 0., 0., 0.2958, 0.1732, 0.,
         0., 0.1732, 0.0631, 0., 0.],
        [-0.0192, 0.0650, -0.0192, 0., 0.0495, 0.1359, 0.0495, 0., 0.1359,
         0.2320, 0.1359, 0., 0.0495, 0.1359, 0.0495, 0.],
        [-0.1002, -0.0206, 0.0697, -0.0206, -0.0206, 0.0530, 0.1456, 0.0530,
         0.0697, 0.1456, 0.2487, 0.1456, -0.0206, 0.0530, 0.1456, 0.0530],
        [0., -0.1303, -0.0268, 0.0906, 0., -0.0268, 0.0690, 0.1894, 0., 0.0906,
         0.1894, 0.3234, 0., -0.0268, 0.0690, 0.1894],
        [0., 0., 0., 0., 0.1085, -0.0321, 0., 0., 0.2268, 0.0826, 0., 0.,
         0.3873, 0.2268, 0., 0.],
        [0., 0., 0., 0., -0.0251, 0.0849, -0.0251, 0., 0.0647, 0.1776, 0.0647,
         0., 0.1776, 0.3032, 0.1776, 0.],
        [0., 0., 0., 0., -0.1303, -0.0268, 0.0906, -0.0268, -0.0268, 0.0690,
         0.1894, 0.0690, 0.0906, 0.1894, 0.3234, 0.1894],
        [0., 0., 0., 0., 0., -0.1695, -0.0349, 0.1179, 0., -0.0349, 0.0898,
         0.2465, 0., 0.1179, 0.2465, 0.4209]])
    correct_gn = torch.Tensor([[0.0530, 0.1456, 0.0530, -0.0206],
                               [0.1456, 0.2487, 0.1456, 0.0697],
                               [0.0530, 0.1456, 0.0530, -0.0206],
                               [-0.0206, 0.0697, -0.0206, -0.1002]])
    assert torch.allclose(correct_hh, hh, atol=1e-3)
    assert torch.allclose(correct_gn, gn, atol=1e-3)


def test_csfsso():
    """
    """
    (h, cssfo, csft, oe) = ell1.csfsso(64, 4, 330.74, 7.28, 0.837, 1.908, 1,
                                       6.664)
    correct_h = torch.Tensor([[2.8594, 7.8499, 2.8594, -1.1117],
                              [7.8499, 13.4051, 7.8499, 3.7551],
                              [2.8594, 7.8499, 2.8594, -1.1117],
                              [-1.1117, 3.7551, -1.1117, -5.3994]])
    correct_cssfo = torch.Tensor([[0.0007, 0.8812, 4.0785, 0.8812],
                                  [0.8812, 0.4954, 36.7277, 0.4954],
                                  [4.0785, 36.7277, 53.9061, 36.7277],
                                  [0.8812, 0.4954, 36.7277, 0.4954]])
    correct_csft = torch.Tensor([[0.6603, 2.4276, 4.0785, 2.4276],
                                 [2.4276, 14.7785, 36.7277, 14.7785],
                                 [4.0785, 36.7277, 53.9061, 36.7277],
                                 [2.4276, 14.7785, 36.7277, 14.7785]])
    correct_oe = torch.Tensor([[0.0011, 0.3630, 1.0000, 0.3630],
                               [0.3630, 0.0335, 1.0000, 0.0335],
                               [1.0000, 1.0000, 1.0000, 1.0000],
                               [0.3630, 0.0335, 1.0000, 0.0335]])
    assert torch.allclose(correct_h, h, atol=1e-3)
    assert torch.allclose(correct_cssfo, cssfo, atol=1e-3)
    assert torch.allclose(correct_csft, csft, atol=1e-3)
    assert torch.allclose(correct_oe, oe, atol=1e-3)


def test_fsamp2():
    """
    """
    f1 = torch.Tensor([[7.4217e-4, 0.8812, 4.0785, 0.8812],
                       [0.8812, 0.4954, 36.7277, 0.4954],
                       [4.0785, 36.7277, 53.9061, 36.7277],
                       [0.8812, 0.4954, 36.7277, 0.4954]])
    h = ell1.fsamp2(f1)
    correct_h = torch.Tensor([[2.8594, 7.8499, 2.8594, -1.1117],
                              [7.8499, 13.4051, 7.8499, 3.7551],
                              [2.8594, 7.8499, 2.8594, -1.1117],
                              [-1.1117, 3.7551, -1.1117, -5.3994]])
    assert torch.allclose(correct_h, h, atol=1e-3)


def test_convmtx2():
    """
    """
    kernel = torch.Tensor([[1., 2.], [3., 4.]])
    N = 3
    convMat, blockMat, convVec = ell1.convmtx2(kernel, N, N)

    correct_convMat = torch.Tensor([
        [1., 0., 0., 0., 0., 0., 0., 0., 0.],
        [3., 1., 0., 0., 0., 0., 0., 0., 0.],
        [0., 3., 1., 0., 0., 0., 0., 0., 0.],
        [0., 0., 3., 0., 0., 0., 0., 0., 0.],
        [2., 0., 0., 1., 0., 0., 0., 0., 0.],
        [4., 2., 0., 3., 1., 0., 0., 0., 0.],
        [0., 4., 2., 0., 3., 1., 0., 0., 0.],
        [0., 0., 4., 0., 0., 3., 0., 0., 0.],
        [0., 0., 0., 2., 0., 0., 1., 0., 0.],
        [0., 0., 0., 4., 2., 0., 3., 1., 0.],
        [0., 0., 0., 0., 4., 2., 0., 3., 1.],
        [0., 0., 0., 0., 0., 4., 0., 0., 3.],
        [0., 0., 0., 0., 0., 0., 2., 0., 0.],
        [0., 0., 0., 0., 0., 0., 4., 2., 0.],
        [0., 0., 0., 0., 0., 0., 0., 4., 2.],
        [0., 0., 0., 0., 0., 0., 0., 0., 4.]])
    assert torch.allclose(correct_convMat, convMat, atol=1e-1)
